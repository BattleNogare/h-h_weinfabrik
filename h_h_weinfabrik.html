<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>H&H Weinfabrik</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0d1117;
      --panel:#151b23;
      --panel-2:#1b2230;
      --ink:#f6f7f9;
      --muted:#a9b4c2;
      --accent:#ffd700;
      --border:#2a3342;
      --blur:8px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg) no-repeat center/cover fixed;
    }
    .page{max-width:1200px;margin:0 auto;padding:1.5rem;}
    header{
      display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.05));
      border-radius:12px;padding:1rem 1.25rem;border:1px solid var(--border);
    }
    header img.logo{height:84px;width:auto;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));}
    header h1{margin:.2rem 0 0;font-size:clamp(1.4rem, 2.8vw, 2rem);letter-spacing:.4px;}
    .hint{margin:1rem 0;padding:.9rem 1rem;border-left:4px solid var(--accent);background:rgba(0,0,0,.25);border-radius:6px;}
    .error{color:#ff9aa2;border-color:#ff9aa2;background:rgba(255,0,0,.06);}
    /* Weine Grid (3 Spalten auf Desktop) */
    .grid{
      display:grid;gap:1rem;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr;} }
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;
      transition:transform .15s ease, box-shadow .15s ease;cursor:pointer;
    }
    .card:focus,.card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.25);}
    .card img{
      width:100%;height:220px;object-fit:cover;background:#0b0f16;
      display:block;
    }
    .card .meta{padding:.75rem .9rem .95rem;}
    .card .name{font-weight:600;margin:0 0 .25rem;font-size:1.05rem;}
    .card .price{color:var(--accent);font-weight:600;}
    /* Modal + Blur-Effekt */
    .blur-wrap.blur .content-to-blur{filter:blur(var(--blur));pointer-events:none;user-select:none;}
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:1.25rem;z-index:30;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(900px, 96vw);max-height:90vh;overflow:auto;
      background:var(--panel-2);border:1px solid var(--border);border-radius:14px;
      box-shadow:0 25px 60px rgba(0,0,0,.45);
    }
    .modal-media{position:relative;background:#0b0f16;}
    .modal-media img{width:100%;height:420px;object-fit:contain;display:block;}
    .modal-body{padding:1rem 1.1rem 1.2rem;}
    .modal-title{margin:.2rem 0 .4rem;font-size:1.35rem;}
    .modal-price{color:var(--accent);font-weight:700;margin:0 0 .6rem;}
    .modal-desc{color:var(--muted);line-height:1.45;white-space:pre-wrap;}
    .close-hint{color:var(--muted);font-size:.9rem;margin-top:.8rem;}
    /* Ankauf */
    .ankauf{
      margin:2rem 0 1rem;background:var(--panel);border:1px solid var(--border);
      border-radius:12px;overflow:hidden;
    }
    .ankauf h2{margin:0;padding:.85rem 1rem;border-bottom:1px solid var(--border);background:rgba(0,0,0,.25);}
    .ankauf-list{padding:.5rem 1rem 1rem;display:grid;gap:.5rem;}
    .ankauf-item{
      display:flex;justify-content:space-between;gap:1rem;
      padding:.6rem .75rem;border:1px dashed var(--border);border-radius:10px;background:rgba(0,0,0,.2);
    }
    .ankauf-item .what{font-weight:600;}
    .ankauf-item .price{color:var(--accent);font-weight:700;}
    a, button{color:inherit}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;}
  </style>
</head>
<body>
  <div class="blur-wrap" id="blurWrap">
    <div class="page content-to-blur">
      <header>
        <img class="logo" id="logoImg" alt="H&H Weinfabrik Logo" />
        <h1>H&amp;H Weinfabrik</h1>
      </header>

      <div id="hint" class="hint">üîÑ Lade Daten aus Google Sheets ‚Ä¶</div>

      <section aria-labelledby="weineTitle">
        <h2 id="weineTitle" class="sr-only">Unsere Weine</h2>
        <div id="weineGrid" class="grid"></div>
      </section>

      <section class="ankauf" aria-labelledby="ankaufTitle">
        <h2 id="ankaufTitle">Ankauf</h2>
        <div id="ankaufList" class="ankauf-list"></div>
      </section>
    </div>

    <!-- Modal / Overlay -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal" id="modalCard">
        <div class="modal-media">
          <img id="modalImg" alt="" />
        </div>
        <div class="modal-body">
          <h3 id="modalTitle" class="modal-title"></h3>
          <div id="modalPrice" class="modal-price"></div>
          <div id="modalDesc" class="modal-desc"></div>
          <div class="close-hint">Tipp: Nochmal auf den Wein klicken, um zu schlie√üen.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== Konfiguration ====== */
const SHEET_ID   = "18Q64WpaE2NAEmva0Y8dABSamcMfzcbVp2CJ1ToZ9Il8";
const TAB_WEBSITE= "Website";
const TAB_WEINE  = "Weine";
const TAB_ANKAUF = "Ankauf";

/* ====== DOM ====== */
const hintEl     = document.getElementById('hint');
const weineGrid  = document.getElementById('weineGrid');
const ankaufList = document.getElementById('ankaufList');
const logoImg    = document.getElementById('logoImg');
const overlay    = document.getElementById('overlay');
const blurWrap   = document.getElementById('blurWrap');
const modalImg   = document.getElementById('modalImg');
const modalTitle = document.getElementById('modalTitle');
const modalPrice = document.getElementById('modalPrice');
const modalDesc  = document.getElementById('modalDesc');

/* ====== Helpers ====== */
function gvizJSONP(sheetName, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const cb = "gvizCb_"+Math.random().toString(36).slice(2);
    const url= `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json,responseHandler:${cb}&headers=1&sheet=${encodeURIComponent(sheetName)}`;
    const script=document.createElement("script");
    let to=setTimeout(()=>{cleanup();reject(new Error("Timeout beim Laden der Tabelle: "+sheetName));}, timeoutMs);
    function cleanup(){ clearTimeout(to); try{delete window[cb];}catch(_){} if(script.parentNode) script.parentNode.removeChild(script); }
    window[cb]=(payload)=>{
      cleanup();
      try{
        const cols = payload.table.cols.map(c => (c.label||c.id||"").trim());
        const rows = payload.table.rows.map(r=>{
          const o={}; (r.c||[]).forEach((cell,i)=>o[cols[i]||("c"+i)]=cell?cell.v:"");
          return o;
        });
        resolve(rows);
      }catch(e){ reject(e); }
    };
    script.src=url;
    script.onerror=()=>{cleanup();reject(new Error("GViz Fehler f√ºr: "+sheetName));};
    document.head.appendChild(script);
  });
}
const fmtPrice = v => String(v ?? "").toString().trim();

/* ====== UI Build ====== */
function setBackground(url){
  if(!url) return;
  document.body.style.backgroundImage = `url("${url}")`;
}
function setLogo(url){
  if(!url) return;
  logoImg.src = url;
  logoImg.addEventListener('error', ()=>{ logoImg.removeAttribute('src'); });
}
function buildWineCard(wine){
  const card = document.createElement('article');
  card.className = 'card';
  card.tabIndex = 0;
  card.setAttribute('role','button');
  card.setAttribute('aria-label', `${wine.Name} ‚Äì ${wine.Preis}`);

  const img = document.createElement('img');
  img.alt = wine.Name || "Wein";
  img.src = wine.Bild || "";

  const meta = document.createElement('div');
  meta.className = 'meta';

  const name = document.createElement('p');
  name.className = 'name';
  name.textContent = wine.Name || "Unbenannter Wein";

  const price = document.createElement('div');
  price.className = 'price';
  price.textContent = fmtPrice(wine.Preis || "");

  meta.appendChild(name);
  meta.appendChild(price);
  card.appendChild(img);
  card.appendChild(meta);

  // Klick/Enter ‚Üí Modal
  const openModal = () => showModal(wine);
  card.addEventListener('click', openModal);
  card.addEventListener('keydown', (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModal(); } });

  return card;
}
function showModal(wine){
  modalImg.src = wine.Bild || "";
  modalImg.alt = wine.Name || "Wein";
  modalTitle.textContent = wine.Name || "";
  modalPrice.textContent = fmtPrice(wine.Preis || "");
  modalDesc.textContent  = (wine.Beschreibung||"").toString().trim();
  overlay.classList.add('show');
  blurWrap.classList.add('blur');
}
function hideModal(){
  overlay.classList.remove('show');
  blurWrap.classList.remove('blur');
}
overlay.addEventListener('click', (e)=>{
  // klickt man au√üerhalb der Karte oder auf die Karte selbst erneut ‚Üí schlie√üen
  if(e.target === overlay || e.target.closest('#modalCard')) hideModal();
});
document.addEventListener('keydown', (e)=>{ if(e.key==="Escape") hideModal(); });

/* ====== Daten laden & rendern ====== */
(async function init(){
  try{
    hintEl.textContent = "üîÑ Lade Daten ‚Ä¶";

    const [websiteRows, weinRows, ankaufRows] = await Promise.all([
      gvizJSONP(TAB_WEBSITE).catch(()=>[]),
      gvizJSONP(TAB_WEINE).catch(()=>[]),
      gvizJSONP(TAB_ANKAUF).catch(()=>[])
    ]);

    // Website: ID | Funktion | Link  (wir nutzen Funktion=Logo/Hintergrund)
    let logoURL="", bgURL="";
    for(const r of websiteRows){
      const f = String(r.Funktion||"").trim().toLowerCase();
      const link = String(r.Link||"").trim();
      if(f==="logo")        logoURL = link || logoURL;
      if(f==="hintergrund") bgURL   = link || bgURL;
    }
    setLogo(logoURL);
    setBackground(bgURL);

    // Weine: ID | Name | Beschreibung | Preis | Bild
    const wines = weinRows
      .map(r=>({
        ID: r.ID,
        Name: r.Name,
        Beschreibung: r.Beschreibung,
        Preis: r.Preis,
        Bild: r.Bild
      }))
      // optional: leere ohne Bild/Name herausfiltern
      .filter(w => (w.Name && w.Bild));

    if(!wines.length){
      weineGrid.innerHTML = `<div class="hint error">Keine Weine gefunden. Bitte Tabelle "${TAB_WEINE}" pr√ºfen.</div>`;
    } else {
      weineGrid.innerHTML = "";
      for(const w of wines){ weineGrid.appendChild(buildWineCard(w)); }
    }

    // Ankauf: ID | Anwendung | Preis
    const buys = ankaufRows.map(r=>({ Anwendung:r.Anwendung, Preis:r.Preis }))
                           .filter(x => x.Anwendung || x.Preis);
    if(!buys.length){
      ankaufList.innerHTML = `<div class="hint">Keine Ankaufdaten vorhanden.</div>`;
    }else{
      ankaufList.innerHTML = "";
      for(const b of buys){
        const row = document.createElement('div');
        row.className = 'ankauf-item';
        const what = document.createElement('div');
        what.className = 'what';
        what.textContent = b.Anwendung || "‚Äî";
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = fmtPrice(b.Preis || "");
        row.appendChild(what);
        row.appendChild(price);
        ankaufList.appendChild(row);
      }
    }

    hintEl.textContent = "üç∑ Willkommen bei der H&H Weinfabrik!";
  }catch(err){
    console.error(err);
    hintEl.classList.add('error');
    hintEl.textContent = "‚ùå Fehler beim Laden der Daten: " + err.message;
  }
})();
</script>
</body>
</html>
