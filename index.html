<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>H&H Weinfabrik</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link id="dynFavicon" rel="icon" href="">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --wine-900:#12060a;
      --wine-800:#1b0b10;
      --wine-700:#2a121b;
      --ink:#f2eceb;
      --muted:#cdb9b8;
      --line:#3b1d26;
      --focus:#c27c8b55;
      --radius:14px;
      --price-wine:#b31636;
    }

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      background:var(--wine-900) no-repeat center/cover fixed;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      line-height:1.45;
    }
    .page{max-width:1280px;margin:0 auto;padding:2rem 1.2rem}

    header{
      display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
      padding:1rem 1.25rem;border:1px solid var(--line);border-radius:var(--radius);
      background:
        radial-gradient(900px 400px at 10% -20%, rgba(194,124,139,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.18));
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    header img.logo{height:90px;width:auto;object-fit:contain}
    .brand h1{margin:0;font-weight:750;font-size:clamp(1.6rem,3vw,2.2rem)}
    .brand .sub{margin:0;color:var(--muted);font-size:.98rem}

    .header-text{
      margin:1rem 0 1.2rem;padding:1rem 1.2rem;border:1px solid var(--line);
      background:var(--wine-800);border-radius:12px;color:var(--muted)
    }
    .header-text .inner{max-width:50%;white-space:pre-wrap}
    @media (max-width:900px){.header-text .inner{max-width:100%}}

    .hint{
      margin:1rem 0 1.2rem;padding:.85rem 1rem;border:1px solid var(--line);
      background:var(--wine-800);border-radius:12px;color:var(--muted)
    }

    hr.rule{height:1px;border:0;margin:1.4rem 0;background:linear-gradient(90deg,transparent,var(--line),transparent)}

    .grid{display:grid;gap:1rem;grid-template-columns:repeat(3,1fr)}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:620px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--wine-700);border:1px solid var(--line);border-radius:var(--radius);
      overflow:hidden;cursor:pointer;transition:transform .18s, box-shadow .18s, border-color .18s
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(0,0,0,.35);border-color:var(--focus)}
    .card img{width:100%;height:230px;object-fit:cover;display:block;background:#0b0f16}
    .meta{padding:.85rem 1rem 1rem;text-align:center}
    .name{margin:0 0 .35rem;font-weight:700}

    .price{
      font-family:"Orbitron","Arial Black",sans-serif;
      font-weight:800;
      text-align:center;
      color:var(--price-wine);
      letter-spacing:1px;
      font-size:1.8rem;
      word-break:break-word;
    }

    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:1.25rem;z-index:30;
      backdrop-filter:saturate(120%) blur(2px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(980px,96vw);max-height:92vh;overflow:auto;
      background:var(--wine-700);border:1px solid var(--line);border-radius:18px;
      box-shadow:0 30px 70px rgba(0,0,0,.5)
    }
    .modal-media img{width:100%;height:440px;object-fit:contain;display:block;background:#0b0f16}
    .modal-body{padding:1rem 1.15rem 1.25rem}
    .modal-title{margin:.2rem 0 .35rem;font-size:1.45rem;font-weight:800;text-align:center}
    .modal-price{margin:0 0 .8rem;text-align:center}

    .modal-flex{display:flex;gap:.5rem;align-items:flex-start}
    .modal-left{
      flex:0 0 20%;
      display:flex;align-items:flex-start;justify-content:flex-start;
      overflow:hidden; height:auto; padding:0;
    }
    .modal-left img{
      width:100%; height:100%; object-fit:contain; display:block;
    }
    .modal-right{flex:1 1 80%;min-width:0}
    .modal-desc{color:var(--muted);white-space:pre-wrap;margin:0}

    @media (max-width:900px){
      .modal-flex{flex-direction:column}
      .modal-left{flex-basis:auto;height:auto}
      .modal-left img{height:auto;max-height:60vh}
    }

    .ankauf-wrap{display:grid;gap:1rem;align-items:start;grid-template-columns:1fr 1fr;margin:1.4rem 0 .6rem}
    @media (max-width:900px){.ankauf-wrap{grid-template-columns:1fr}}
    .ankauf-list{background:var(--wine-800);border:1px solid var(--line);border-radius:var(--radius);padding:.8rem .9rem 1rem}
    .ankauf-list h2{margin:.2rem 0 .6rem;font-size:1.15rem}
    .ankauf-item{display:flex;justify-content:space-between;align-items:center;padding:.65rem .7rem;border:1px dashed var(--line);border-radius:12px;background:var(--wine-700)}
    .ankauf-item .what{font-weight:650}
    .ankauf-item .price{min-width:120px}
    .ankauf-media{background:transparent;border:none;padding:0;display:flex;justify-content:flex-start;align-items:flex-start;height:100%}
    .ankauf-media img{border:none;background:transparent;max-width:100%;max-height:100%;object-fit:contain;object-position:left top;display:block}

    .section{background:var(--wine-800);border:1px solid var(--line);border-radius:var(--radius);padding:1rem 1.2rem;margin:1.2rem 0}
    .section .desc{color:var(--muted);margin:0 0 .8rem}

    #standortImg{
      width:100%;
      height:auto;
      object-fit:contain;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0b0f16;
      display:block;
      margin-bottom:1rem;
    }

    .photo-row{display:grid;gap:.9rem;grid-template-columns:1fr}
    @media (min-width:900px){.photo-row{grid-template-columns:1fr 1fr}}
    .photo{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;border:1px solid var(--line)}

    footer.footer{margin:1.5rem 0 .5rem;color:var(--muted);font-size:.85rem;text-align:center}
    footer.footer a{color:var(--ink);text-decoration:underline}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <img class="logo" id="logoImg" alt="Logo" />
      <div class="brand">
        <h1>H&amp;H Weinfabrik</h1>
        <p class="sub" id="logoDesc"></p>
      </div>
    </header>

    <div id="headerText" class="header-text" hidden><div class="inner" id="headerTextInner"></div></div>

    <div id="hint" class="hint">🔄 Lade Daten aus Google Sheets …</div>

    <section>
      <div id="weineGrid" class="grid"></div>
    </section>

    <hr class="rule" />

    <section>
      <div class="ankauf-wrap">
        <div class="ankauf-list" id="ankaufListBlock">
          <h2>Ankauf</h2>
          <ul id="ankaufList"></ul>
        </div>
        <div class="ankauf-media"><img id="ankaufImg" alt="Ankauf"></div>
      </div>
    </section>

    <section class="section" id="standortSection" hidden>
      <h2>Standort</h2>
      <p class="desc" id="standortDesc"></p>
      <img id="standortImg" alt="Standort" />
      <div class="photo-row">
        <img id="photo1" class="photo" alt="Foto 1" />
        <img id="photo2" class="photo" alt="Foto 2" />
      </div>
    </section>

    <footer id="siteFooter" class="footer" hidden>
      <div id="footerDesc"></div>
      <div><a id="footerLink" href="#" target="_blank" rel="noopener"></a></div>
    </footer>
  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="modal-media"><img id="modalImg" alt=""></div>
      <div class="modal-body">
        <h3 id="modalTitle" class="modal-title"></h3>
        <div id="modalPrice" class="modal-price price"></div>

        <div class="modal-flex" id="modalFlex">
          <div class="modal-left" id="modalLeft">
            <img id="modalImg2" alt="Weinbild 2">
          </div>
          <div class="modal-right">
            <div id="modalDesc" class="modal-desc"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
const SHEET_ID="18Q64WpaE2NAEmva0Y8dABSamcMfzcbVp2CJ1ToZ9Il8";
const TAB_WEBSITE="Website",TAB_WEINE="Weine",TAB_ANKAUF="Ankauf";

const logoImg=document.getElementById("logoImg"),logoDescEl=document.getElementById("logoDesc");
const headerText=document.getElementById("headerText"),headerTextInner=document.getElementById("headerTextInner");
const hintEl=document.getElementById("hint");
const weineGrid=document.getElementById("weineGrid");
const ankaufList=document.getElementById("ankaufList"),ankaufImg=document.getElementById("ankaufImg"),ankaufListBlock=document.getElementById("ankaufListBlock");
const standortSection=document.getElementById("standortSection"),standortDescEl=document.getElementById("standortDesc"),
      standortImg=document.getElementById("standortImg"),photo1Img=document.getElementById("photo1"),photo2Img=document.getElementById("photo2");
const siteFooter=document.getElementById("siteFooter"),footerDescEl=document.getElementById("footerDesc"),footerLinkEl=document.getElementById("footerLink");
const overlay=document.getElementById("overlay"),modalImg=document.getElementById("modalImg"),modalTitle=document.getElementById("modalTitle"),
      modalPrice=document.getElementById("modalPrice"),modalDesc=document.getElementById("modalDesc"),modalImg2=document.getElementById("modalImg2"),
      modalLeft=document.getElementById("modalLeft");
const faviconEl=document.getElementById("dynFavicon");

/* Sheets Loader */
function gvizJSONP(sheet){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const u=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json,responseHandler:${cb}&headers=1&sheet=${sheet}`;
    const s=document.createElement("script");
    let to=setTimeout(()=>{rej("Timeout "+sheet);cleanup();},15000);
    function cleanup(){clearTimeout(to);try{delete window[cb];}catch{}s.remove();}
    window[cb]=p=>{
      cleanup();
      try{
        const cols=p.table.cols.map(c=>(c.label||c.id||"").trim());
        const rows=p.table.rows.map(r=>{
          const o={};
          (r.c||[]).forEach((cell,i)=>{
            o[cols[i]||("c"+i)]=cell?cell.v:"";
          });
          return o;
        });
        res(rows);
      }catch(e){rej(e);}
    };
    s.src=u;
    document.head.appendChild(s);
  });
}

/* Preis auswählen:
   1. Wenn r.Preis definiert ist und nicht leer → nimm das.
   2. Sonst: nimm den "besten" anderen Wert aus der Zeile (längster String, der nicht komplett leer ist).
*/
function pickPreisSmart(rowObj){
  if (rowObj.Preis !== undefined && String(rowObj.Preis).trim() !== "") {
    return String(rowObj.Preis).trim();
  }

  let fallback = "";
  for (const key of Object.keys(rowObj)) {
    const val = rowObj[key];
    if (val === undefined || val === null) continue;
    const txt = String(val).trim();
    if (!txt) continue;
    // Wir wollen hier keine Beschreibung oder Bild-URL als Preis missbrauchen.
    // Deswegen skippen wir Felder, die wie URLs aussehen oder sehr lang sind.
    const looksLikeURL = /^https?:\/\//i.test(txt);
    if (looksLikeURL) continue;
    if (txt.length > 60) continue; // sehr langer Text => eher Beschreibung

    // Behalte den längsten Kandidaten, z.B. "650€ - 1200€" statt nur "650€"
    if (txt.length > fallback.length) {
      fallback = txt;
    }
  }

  return fallback;
}

/* Ankaufpreis formatieren (€/St.) */
function euro(v){
  if(v==null||v==="")return"";
  let s=String(v).trim().replace(/[^\d.,-]/g,"");
  if(!s)return"";
  const d=s.lastIndexOf("."),c=s.lastIndexOf(",");const comma=c>d;
  if(comma){
    s=s.replace(/\./g,"").replace(",",".");
  }else{
    s=s.replace(/,/g,"");
  }
  const n=Number(s);
  return isFinite(n)?n.toLocaleString("de-DE")+" €":String(v);
}
function euroProStueck(v){
  const t=euro(v);
  return t ? t.replace(/\s*€$/," €")+"/St." : "";
}

/* Wein-Karte bauen */
function buildWineCard(w){
  const c=document.createElement("article");
  c.className="card";

  const img=document.createElement("img");
  img.src=w.BildAI||w.Bild||"";
  img.alt=w.Name||"Wein";

  const meta=document.createElement("div");
  meta.className="meta";

  const name=document.createElement("p");
  name.className="name";
  name.textContent=w.Name||"";

  const price=document.createElement("div");
  price.className="price";
  price.textContent=w.PreisText || "";

  meta.append(name,price);
  c.append(img,meta);

  c.onclick=()=>showModal(w);

  return c;
}

/* Modal anzeigen */
function showModal(w){
  modalImg.src=w.BildAI||w.Bild||"";
  modalTitle.textContent=w.Name||"";
  modalPrice.textContent=w.PreisText || "";
  modalDesc.textContent=(w.Beschreibung||"").toString().trim();

  if(w.Bild2){
    modalImg2.src=w.Bild2;
    modalLeft.style.display="flex";
    modalImg2.style.display="block";
    if(modalImg2.complete){
      syncModalHeights();
    }else{
      modalImg2.onload=()=>syncModalHeights();
    }
  }else{
    modalImg2.removeAttribute("src");
    modalImg2.style.display="none";
    modalLeft.style.display="none";
  }

  overlay.classList.add("show");
  requestAnimationFrame(syncModalHeights);
}

/* Klick außerhalb Modal schließt */
overlay.onclick=()=>overlay.classList.remove("show");

/* Bild2-Höhensync */
function syncModalHeights(){
  if(window.matchMedia("(max-width: 900px)").matches){
    modalLeft.style.height="auto";
    return;
  }
  if(modalLeft.style.display==="none") return;
  const descH=modalDesc.getBoundingClientRect().height;
  modalLeft.style.height=Math.max(descH,80)+"px";
}

/* Ankauf-Höhensync */
function syncAnkaufHeights(){
  const h=ankaufListBlock.getBoundingClientRect().height;
  ankaufImg.style.maxHeight=h+"px";
}

/* Init */
(async()=>{
  try{
    const [ws,weine,ank]=await Promise.all([
      gvizJSONP(TAB_WEBSITE),
      gvizJSONP(TAB_WEINE),
      gvizJSONP(TAB_ANKAUF)
    ]);

    // WEBSITE-DATEN
    let logo="",bg="",fav="",descLogo="",headerDesc="",ankImgURL="",standort="",descStandort="",p1="",p2="",footerD="",footerL="";
    ws.forEach(r=>{
      const f=(r.Funktion||"").toLowerCase();
      if(f==="logo"){logo=r.Link;descLogo=r.Beschreibung}
      if(f==="hintergrund"){bg=r.Link}
      if(f==="favicon-link"||f==="favicon"){fav=r.Link}
      if(f==="header"){headerDesc=r.Beschreibung}
      if(f==="ankauf"){ankImgURL=r.Link}
      if(f==="standort"){standort=r.Link;descStandort=r.Beschreibung}
      if(f==="photo1"){p1=r.Link}
      if(f==="photo2"){p2=r.Link}
      if(f==="footer"){footerD=r.Beschreibung;footerL=r.Link}
    });

    if(logo) logoImg.src=logo;
    if(bg) document.body.style.backgroundImage=`url('${bg}')`;
    if(fav) faviconEl.href=fav;
    logoDescEl.textContent=descLogo||"";
    if(headerDesc){
      headerTextInner.textContent=headerDesc;
      headerText.hidden=false;
    }

    // WEINE
    weineGrid.innerHTML="";
    weine.forEach(r=>{
      const preisText = pickPreisSmart(r);

      const w={
        ID:r.ID,
        Name:r.Name,
        Beschreibung:r.Beschreibung,
        PreisText:preisText,
        BildAI:r.BildAI,
        Bild2:r.Bild2,
        Bild:r.Bild
      };

      if(w.Name && (w.BildAI || w.Bild)){
        weineGrid.append(buildWineCard(w));
      }
    });

    // ANKAUF
    if(ankImgURL) ankaufImg.src=ankImgURL;
    ankaufList.innerHTML="";
    ank.forEach(a=>{
      const li=document.createElement("li");
      li.className="ankauf-item";
      li.innerHTML=`<div class="what">${a.Anwendung||""}</div><div class="price">${euroProStueck(a.Preis||"")}</div>`;
      ankaufList.append(li);
    });

    // STANDORT & FOTOS
    if(standort||descStandort||p1||p2){
      standortSection.hidden=false;
      standortDescEl.textContent=descStandort||"";
      if(standort) standortImg.src=standort;
      if(p1) photo1Img.src=p1;
      if(p2) photo2Img.src=p2;
    }

    // FOOTER
    if(footerD||footerL){
      if(footerD) footerDescEl.textContent=footerD;
      if(footerL){
        footerLinkEl.textContent=footerL;
        footerLinkEl.href=footerL;
      }
      siteFooter.hidden=false;
    }

  }catch(e){
    console.error(e);
    const err=document.createElement("div");
    err.className="hint";
    err.textContent="❌ Fehler beim Laden: "+e;
    document.querySelector(".page").prepend(err);
  }finally{
    if(hintEl && hintEl.parentNode) hintEl.parentNode.removeChild(hintEl);
    syncAnkaufHeights();
    window.addEventListener("resize", ()=>{
      syncAnkaufHeights();
      syncModalHeights();
    });
  }
})();
</script>
</body>
</html>
